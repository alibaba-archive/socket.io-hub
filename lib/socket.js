// Generated by CoffeeScript 1.6.2
(function() {
  var Hub, Socket, exports, _,
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  Socket = require('socket.io/lib/socket');

  Hub = require('./hub');

  _ = require('underscore');

  Socket.prototype.$$emit = Socket.prototype.emit;

  Socket.prototype.subscribe = function() {
    var _this = this;

    if (Hub.adapterActive && !this.isSubscribed) {
      this.isSubscribed = true;
      return Hub.adapter.on(function(data) {
        _this.namespace.name = data._namespace || '';
        if (_this.needSubEmit(data)) {
          delete data._pid;
          delete data._flags;
          delete data._namespace;
          return _this.$$emit.apply(_this, _.toArray(data));
        }
      });
    }
  };

  Socket.prototype.emit = function(ev) {
    var data;

    if (this.needAdapter()) {
      data = _.clone(arguments);
      data._pid = process.pid;
      data._flags = this.flags;
      Hub.adapter.pub(Hub.channel, data);
    }
    return this.$$emit.apply(this, arguments);
  };

  Socket.prototype.needAdapter = function() {
    if (Hub.adapterActive) {
      return true;
    } else {
      return false;
    }
  };

  Socket.prototype.needSubEmit = function(data) {
    var cutLength, namespace, room, _ref;

    if (process.pid === data._pid) {
      return false;
    }
    if (data._flags.broadcast) {
      return true;
    }
    if (data._flags.endpoint !== '') {
      namespace = data._namespace || '';
      cutLength = namespace.length > 0 ? namespace.length + 1 : 0;
      room = data._flags.endpoint.substr(cutLength);
      if ((this.manager.rooms[room] != null) && (_ref = this.id, __indexOf.call(this.manager.rooms[room], _ref) >= 0)) {
        return true;
      }
    }
    return false;
  };

  exports = module.exports = Socket;

}).call(this);
